🌙 LoomRoom — 公式仕様書（システム設計 / アカウント体系 / 安全設計）

最終更新：2025-12-05（整形版）

1. アカウントロール構造
- 1.1 一般ユーザー（role = user）
- - 投稿：○
- - いいね：○
- - ブックマーク：○
- - DM：セラピスト宛のみ可（一般→一般は不可）
- - 年齢制限：18歳以上
1.2 セラピスト（role = therapist）
- - 所属店舗（shopId）必須
- - 投稿：○
- - DM：一般ユーザーからの受信 & 返信のみ可
- - プロフィール詳細設定：○
- - 年齢制限：18歳以上
1.3 店舗アカウント（role = store）
- - 初期フェーズは LuX nagoya のみ
- - 投稿：告知中心
- - DM：ユーザー / セラピスト ともに可

2. 年齢制限・安全設計
- ■ ログイン前 18歳確認モーダル
- - 「はい」 → LocalStorage に記録し利用許可
- - 「いいえ」 → 利用不可
- ■ 登録時
- - 生年月日入力
- - 18歳以上チェック必須
- ■ 未成年者の投稿・画像・プロフィールは禁止

3. タイムライン仕様
- 3.1 みんな（全投稿）
- - 完全時系列（新しい順）
- - アルゴリズムなし
- 3.2 ホーム（フォロー）
- - 自分＋フォロー中ユーザーの投稿のみ表示

4. 投稿フィルタ
- エリアで絞り込み
- （全国 / 北海道・東北 / 関東 / 中部 / 関西 / 中国・四国 / 九州・沖縄）
- ロールで絞り込み
- （すべて / セラピスト / 店舗 / 一般ユーザー）

5. ユーザー関係（フォロー / ミュート / ブロック）
- ■ フォロー
- - ホームTLに表示される
- ■ ミュート
- - 相手の投稿がTLから非表示
- - 相手に通知なし
- ■ ブロック
- - DM不可
- - プロフィール閲覧不可
- - 完全除外
- - 強制アンフォロー

6. DM仕様
- ■ 6.0 送受信可能な組み合わせ
- - 送り主 → 受信者	可否
- - 一般 → セラピスト	○
- - セラピスト → 一般	○（返信のみ）
- - 一般 → 一般	×（初期フェーズ）
- - ※ 出会い系化防止・安全性の担保のため。
- 6.1 DM スレッド管理仕様（重要）
- 6.1.1 スレ生成タイミング（Instagram方式）
- - ✉ を押しても スレは未作成（仮スレ）
- - 最初のメッセージ送信時に正式スレを作成
- - 仮スレは /messages 一覧に表示されない
- - メリット
- - 誤タップによるスレ乱立を防止
- - UIがシンプルで直感的
- 6.1.2 threadId（スレID）の生成ルール
- - 2人のユーザーIDを アルファベット順でソートし結合する。
- - threadId = sort([myUserId, partnerUserId]).join("_")
- - 例：
- - u_123 と t_aki
- - sort → ["t_aki", "u_123"]
- - threadId → "t_aki_u_123"
- - メリット
- - 同じ2人のスレが2つ以上作られない
- - 誰が開始しても同じスレへ到達
- - 検索・保存・同期が容易
- 6.1.3 スレ再利用ルール
- - 既存 threadId があれば 新規作成しない
- - ✉ を何度押しても同じ threadId に遷移する
- 6.1.4 スレ一覧の表示ルール
- - 1件以上メッセージがあるスレのみ表示
- - メッセージ送信後、以下を更新：
- - lastMessageAt
- - unreadCount（将来実装）
- - 一覧は lastMessageAt の降順でソート
- 6.1.5 DM画面遷移ルール
- - プロフィールの ✉ ボタン →
- - /messages/[threadId]
- - ※ threadId は2人のIDから常に同一生成される。
- 6.1.6 DM動作の例
- - ① ユーザー（u_555）が TAKI（t_aki）に ✉
- - - → 遷移：/messages/t_aki_u_555
- - - → この時点ではスレ未作成（仮スレ）
- - ② 最初のメッセージ送信
- - - → t_aki_u_555 の正式スレ作成
- - - → /messages に表示される
- - ③ 再度 ✉ を押した場合
- - - → 新規作成せず t_aki_u_555 を再利用

7. プロフィール仕様
- 7.1 一般ユーザー
- - ニックネーム
- - アイコン
- - エリア
- - 一言プロフィール
- - 任意タグ
- 7.2 セラピスト
- - 店舗ID（shopId）
- - 活動名
- - エリア
- - プロフィール文章
- - 雰囲気タグ
- - 過ごし方タグ
- - 紹介文
- - ※ LuX MATCH AI のタグ体系を流用可能
- 7.3 店舗アカウント
- - 店舗名
- - ロゴ
- - エリア
- - 店舗情報
- - 所属セラピスト一覧

8. 店舗審査（多店舗展開時）
- - 必要提出物：
- - 風営許可証
- - 代表者身分証
- - 店舗住所・連絡先
- - SNS / HP
- - → 形式確認のみで審査完了。

9. 内部ID体系（URLと完全連動）
- ■ 一般ユーザー
- - ID：u_xxxxx
- - URL：/mypage/u_xxxxx
- ■ セラピスト
- - ID：t_xxxxx
- - URL：/therapist/t_xxxxx
- ■ 店舗
- - ID：s_xxxxx
- - URL：/store/s_xxxxx

10. 登録フロー
- ■ 一般ユーザー
- - /signup → u_xxxx 発行 → /mypage/u_xxxx
- ■ 店舗
- - /signup/creator → 店舗申請 → s_lux 発行 → 店舗コード発行（例：LUX-8F2K）
- ■ セラピスト
- - /signup/creator → 店舗コード入力 → 店舗側で承認 → t_xxxx 発行 → /therapist/t_xxxx

11. 退店（無所属）状態の扱い
- 退店すると：
- shopId = null
- status = "unaffiliated"（無所属）

12. 無所属セラピストへの制限（最重要）
- 12.1 DM禁止
- - DM返信UI 非表示
- - バックエンドで送信拒否
- - 自動返信文：
- - 「現在、所属店舗が無いため、ご返信ができません。」
- 12.2 投稿禁止
- - 投稿ボタン非表示
- - バックエンドで投稿 reject
- - 過去投稿は表示/非表示どちらでも運営判断で可

13. ロール別まとめ
- ロール	投稿	DM	プロフィール編集	アイコン変更
- 一般ユーザー	○	○（セラピストのみ送信）	○	○
- セラピスト（所属あり）	○	○（受信＆返信）	△（ID変更不可）	○
- セラピスト（無所属）	❌	❌	△	○
- 店舗アカウント	○	○	○	○

14. この設計のメリット
- URL と内部IDが完全一致 → 管理容易
- ロールごとの制御がシンプルで安全性が高い
- 無所属セラピストのリスクをゼロ化
- ログイン・プロフィール導線が綺麗で統一感がある
- DM・TL・プロフィールが一貫したドメイン設計で拡張しやすい